// Generated by CoffeeScript 1.7.1
(function() {
  var __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  app.View = (function() {
    function View(el) {
      if (el == null) {
        throw "Cannot construct view without an HTML element";
      }
      this.el = el;
      this.initialize();
      this.render();
      this.events();
    }

    View.prototype.initialize = function() {};

    View.prototype.render = function() {};

    View.prototype.events = function() {};

    return View;

  })();

  app.EntriesCollection = (function() {
    function EntriesCollection() {
      this.restore();
      this.events();
    }

    EntriesCollection.prototype.events = function() {
      document.addEventListener('entry:undo', this);
      return document.addEventListener('question:changed', this);
    };

    EntriesCollection.prototype.handleEvent = function(e) {
      if (e.type === 'entry:undo') {
        this.pop();
      }
      if (e.type === 'question:changed') {
        return this.reset();
      }
    };

    EntriesCollection.prototype.restore = function() {
      this.records = [];
      if (localStorage["mira:entries"] != null) {
        this.records = JSON.parse(localStorage["mira:entries"]).map(function(entry) {
          return new app.Entry(entry);
        });
      }
      this.broadcastChange();
      return this.records;
    };

    EntriesCollection.prototype.save = function() {
      localStorage["mira:entries"] = JSON.stringify(this.records);
      this.broadcastChange();
      return this.records;
    };

    EntriesCollection.prototype.add = function(entry) {
      this.records.push(entry);
      return this.save();
    };

    EntriesCollection.prototype.pop = function() {
      var entry;
      entry = this.records.pop();
      this.save();
      return entry;
    };

    EntriesCollection.prototype.getRecords = function() {
      return this.records.slice(0);
    };

    EntriesCollection.prototype.reset = function() {
      this.records = [];
      document.dispatchEvent(new CustomEvent('entries:reset'));
      return this.save();
    };

    EntriesCollection.prototype.seed = function() {
      var i, _results;
      i = 0;
      _results = [];
      while (i < 20) {
        this.add(new app.Entry({
          answer: 1,
          date: new Date(1987, 0, i)
        }));
        _results.push(i += 1);
      }
      return _results;
    };

    EntriesCollection.prototype.broadcastChange = function() {
      return document.dispatchEvent(new CustomEvent('entries:changed', {
        detail: {
          collection: this
        }
      }));
    };

    return EntriesCollection;

  })();

  app.DateMathView = (function(_super) {
    __extends(DateMathView, _super);

    function DateMathView() {
      return DateMathView.__super__.constructor.apply(this, arguments);
    }

    DateMathView.prototype.events = function() {
      return document.addEventListener('entries:changed', this);
    };

    DateMathView.prototype.handleEvent = function(e) {
      return this.onEntryChange(e);
    };

    DateMathView.prototype.onEntryChange = function(e) {
      var entries, lastDate, lastEntry, now, _ref;
      entries = (_ref = e.detail.collection) != null ? _ref.getRecords() : void 0;
      if (entries != null) {
        lastEntry = entries.pop();
        lastDate = new Date(lastEntry != null ? lastEntry.date : void 0).setHours(0, 0, 0, 0) || 0;
        now = new Date().setHours(0, 0, 0, 0);
        return this.broadcastDate(now, lastDate);
      }
    };

    DateMathView.prototype.broadcastDate = function(now, lastDate) {
      return document.dispatchEvent(new CustomEvent('datemath', {
        detail: {
          now: now,
          then: lastDate
        }
      }));
    };

    return DateMathView;

  })(app.View);

  app.HistoryView = (function(_super) {
    __extends(HistoryView, _super);

    function HistoryView() {
      return HistoryView.__super__.constructor.apply(this, arguments);
    }

    HistoryView.prototype.initialize = function() {
      this.fragment = document.createDocumentFragment();
      return this.months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    };

    HistoryView.prototype.events = function() {
      return document.addEventListener('entries:changed', this);
    };

    HistoryView.prototype.handleEvent = function(e) {
      if (e.type === 'entries:changed') {
        return this.onEntryChange(e);
      }
    };

    HistoryView.prototype.onEntryChange = function(event) {
      this.entries = event.detail.collection.getRecords();
      return this.render();
    };

    HistoryView.prototype.render = function() {
      var entry, _i, _len, _ref;
      this.fragment = document.createDocumentFragment();
      this.el.innerHTML = '';
      if (this.entries != null) {
        _ref = this.entries.reverse();
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          entry = _ref[_i];
          this.renderEntry(entry);
        }
      }
      return this.el.appendChild(this.fragment);
    };

    HistoryView.prototype.renderEntry = function(entry) {
      var date, elem;
      date = new Date(entry.date);
      elem = document.createElement('div');
      elem.className = "entry entry-" + entry.answer;
      elem.id = "entry_" + entry.date;
      elem.innerHTML = "<div class='entry_date'> " + this.months[date.getMonth()] + " " + (date.getDate()) + " </div> <div class='entry_answer'></div>";
      return this.fragment.appendChild(elem);
    };

    return HistoryView;

  })(app.View);

  document.addEventListener('app:started', function(e) {});

  app.InputView = (function(_super) {
    __extends(InputView, _super);

    function InputView() {
      return InputView.__super__.constructor.apply(this, arguments);
    }

    InputView.prototype.events = function() {
      this.el.addEventListener('click', this);
      this.el.addEventListener('touchmove', this);
      return document.addEventListener('datemath', this);
    };

    InputView.prototype.handleEvent = function(e) {
      switch (e.type) {
        case 'click':
          return this.createEntry(e);
        case 'datemath':
          return this.toggle(e);
        case 'touchmove':
          return this.block(e);
      }
    };

    InputView.prototype.createEntry = function(e) {
      var target, val;
      target = e.target;
      val = target.getAttribute('data-val');
      if (val != null) {
        return document.dispatchEvent(new CustomEvent('entry:create', {
          detail: {
            answer: parseInt(val)
          }
        }));
      }
    };

    InputView.prototype.toggle = function(e) {
      var now, prev;
      now = e.detail.now;
      prev = e.detail.then;
      if (now > prev) {
        return this.show();
      } else {
        return this.hide();
      }
    };

    InputView.prototype.show = function() {
      this.el.classList.add('is_visible');
      this.el.style.position = 'relative';
      return this.el.style.opacity = '1';
    };

    InputView.prototype.hide = function() {
      this.el.style.position = 'absolute';
      this.el.style.opacity = '0';
      return this.el.addEventListener('webkitTransitionEnd', (function(_this) {
        return function(e) {
          _this.el.classList.remove('is_visible');
          return _this.el.removeEventListener(e.type, arguments.callee);
        };
      })(this));
    };

    InputView.prototype.block = function(e) {
      return e.preventDefault();
    };

    InputView.prototype.render = function() {
      return this.el.innerHTML = "<div data-val=1 class='button button-yes'>Yes</div> <div data-val=0 class='button button-no'>No</div>";
    };

    return InputView;

  })(app.View);

  app.install = function() {
    var appIcon, canvas, frag, header, installIcon, paragraph;
    canvas = document.getElementById('app');
    appIcon = document.createElement('img');
    appIcon.src = document.querySelector('link[rel=apple-touch-icon]').href;
    installIcon = document.createElement('img');
    installIcon.src = '/assets/share-white.png';
    header = document.createElement('h2');
    header.innerText = 'Tap';
    paragraph = document.createElement('p');
    paragraph.innerText = "in Safari's toolbar to add " + document.title + " to your home screen";
    frag = document.createDocumentFragment();
    frag.appendChild(appIcon);
    frag.appendChild(header);
    frag.appendChild(installIcon);
    frag.appendChild(paragraph);
    canvas.innerHTML = '';
    canvas.classList.add('install');
    return canvas.appendChild(frag);
  };

  app.Entry = (function() {
    function Entry(args) {
      args || (args = {});
      args.date || (args.date = Date.now());
      if (!(args.answer === 1 || args.answer === 0)) {
        throw "Can't create entry without answer";
      }
      this.setDate(args.date);
      this.setAnswer(args.answer);
    }

    Entry.prototype.getDate = function() {
      return this.date;
    };

    Entry.prototype.setDate = function(date) {
      return this.date = date;
    };

    Entry.prototype.getAnswer = function() {
      return this.answer;
    };

    Entry.prototype.setAnswer = function(answer) {
      return this.answer = answer;
    };

    Entry.prototype.getAttributes = function() {
      return {
        date: this.getDate(),
        answer: this.getAnswer()
      };
    };

    return Entry;

  })();

  app.Question = (function() {
    function Question() {
      this.q = localStorage['mira:question'] || "If today were the last day of your life, would you want to do what you're about to do?";
      this.events();
      document.dispatchEvent(new CustomEvent('question:restored', {
        detail: {
          question: this.q
        }
      }));
    }

    Question.prototype.events = function() {
      return document.addEventListener('question:change', this);
    };

    Question.prototype.handleEvent = function(e) {
      return this.changeQuestion(e.detail.question);
    };

    Question.prototype.changeQuestion = function(q) {
      if (q == null) {
        return;
      }
      this.q = localStorage['mira:question'] = q;
      return this.broadcastQuestion();
    };

    Question.prototype.broadcastQuestion = function() {
      return document.dispatchEvent(new CustomEvent('question:changed', {
        detail: {
          question: this.q
        }
      }));
    };

    return Question;

  })();

  app.PromptView = (function(_super) {
    __extends(PromptView, _super);

    function PromptView() {
      return PromptView.__super__.constructor.apply(this, arguments);
    }

    PromptView.prototype.events = function() {
      this.el.addEventListener('click', this);
      this.el.addEventListener('touchmove', function(e) {
        return e.preventDefault();
      });
      document.addEventListener('question:changed', this);
      return document.addEventListener('question:restored', this);
    };

    PromptView.prototype.handleEvent = function(e) {
      if (e.type === 'click') {
        this.newQuestion();
      }
      if (e.type.match(/question/i)) {
        return this.rerender(e);
      }
    };

    PromptView.prototype.rerender = function(e) {
      var q;
      q = e.detail.question;
      this.el.innerHTML = "<h1>" + q + "</h1>";
      if (q.length > 60) {
        return this.el.classList.add('long');
      } else {
        return this.el.classList.remove('long');
      }
    };

    PromptView.prototype.newQuestion = function() {
      var q;
      q = prompt("Ask a new question:");
      if ((q != null) && q.length > 0) {
        return document.dispatchEvent(new CustomEvent('question:change', {
          detail: {
            question: q
          }
        }));
      }
    };

    return PromptView;

  })(app.View);

  app.ScrollView = (function(_super) {
    __extends(ScrollView, _super);

    function ScrollView() {
      return ScrollView.__super__.constructor.apply(this, arguments);
    }

    ScrollView.prototype.events = function() {
      return this.el.addEventListener('touchstart', this);
    };

    ScrollView.prototype.handleEvent = function(e) {
      if (e.type === 'touchstart') {
        return this.onTouchStart(e);
      }
    };

    ScrollView.prototype.onTouchStart = function(e) {
      var atBottom, atTop, height;
      height = this.el.getBoundingClientRect().height;
      atTop = this.el.scrollTop === 0;
      atBottom = this.el.scrollHeight - this.el.scrollTop === height;
      if (atTop) {
        return this.el.scrollTop += 1;
      } else if (atBottom) {
        return this.el.scrollTop -= 1;
      }
    };

    return ScrollView;

  })(app.View);

  app.StatsView = (function(_super) {
    __extends(StatsView, _super);

    function StatsView() {
      return StatsView.__super__.constructor.apply(this, arguments);
    }

    StatsView.prototype.events = function() {
      document.addEventListener('entries:changed', this);
      document.addEventListener('entry:added', this);
      return document.addEventListener('datemath', this);
    };

    StatsView.prototype.handleEvent = function(e) {
      var entries, noPct, now, prev, yesPct;
      if (e.type === 'datemath') {
        now = e.detail.now;
        prev = e.detail.then;
        if (now <= prev) {
          return this.show();
        } else {
          return this.hide();
        }
      } else {
        entries = e.detail.collection.getRecords();
        this.yeas = entries.filter(function(entry) {
          return entry.answer === 1;
        });
        this.nays = entries.filter(function(entry) {
          return entry.answer === 0;
        });
        yesPct = Math.floor(this.yeas.length / entries.length * 100);
        noPct = 100 - yesPct;
        return this.el.innerHTML = "<div class='percentages'> <div data-pct='" + yesPct + "%' class='percentage percentage-yes' style='width: " + yesPct + "%'></div> <div data-pct='" + noPct + "%' class='percentage percentage-no' style='width: " + noPct + "%'></div> </div>";
      }
    };

    StatsView.prototype.show = function() {
      return this.el.style.display = 'block';
    };

    StatsView.prototype.hide = function() {
      return this.el.style.display = 'none';
    };

    return StatsView;

  })(app.View);

  app.UndoView = (function(_super) {
    __extends(UndoView, _super);

    function UndoView() {
      return UndoView.__super__.constructor.apply(this, arguments);
    }

    UndoView.prototype.events = function() {
      window.addEventListener('shake', this);
      return document.addEventListener('entry:create', this);
    };

    UndoView.prototype.handleEvent = function(e) {
      if (e.type === 'entry:create') {
        this.enable();
      }
      if (e.type === 'shake') {
        return this.undo();
      }
    };

    UndoView.prototype.enable = function() {
      return this.enabled = true;
    };

    UndoView.prototype.undo = function() {
      if (!this.enabled) {
        return;
      }
      if (confirm('Undo entry?')) {
        document.dispatchEvent(new CustomEvent('entry:undo'));
        return this.enabled = false;
      }
    };

    return UndoView;

  })(app.View);

}).call(this);
