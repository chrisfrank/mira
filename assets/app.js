// Generated by CoffeeScript 1.7.1
(function() {
  var __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  app.AppController = (function() {
    function AppController() {
      document.dispatchEvent(new CustomEvent('app:starting'));
      app.prompt = "Did you need to be in New York City today?";
      app.views = {
        prompt: new app.PromptView(document.getElementById('prompt')),
        input: new app.InputView(document.getElementById('input')),
        stats: new app.StatsView(document.getElementById('stats')),
        history: new app.HistoryView(document.getElementById('history'))
      };
      app.entries = new app.EntriesCollection();
      this.listen();
      document.dispatchEvent(new CustomEvent('app:loaded'));
    }

    AppController.prototype.listen = function() {
      return document.addEventListener('entry:create', function(e) {
        return app.entries.add(new app.Entry({
          answer: e.detail.answer
        }));
      });
    };

    return AppController;

  })();

  document.addEventListener('DOMContentLoaded', function() {
    return app.controller = new app.AppController;
  });

  app.EntriesCollection = (function() {
    function EntriesCollection() {
      this.restore();
    }

    EntriesCollection.prototype.restore = function() {
      this.records = [];
      if (localStorage["dailyq:entries"] != null) {
        this.records = JSON.parse(localStorage["dailyq:entries"]).map(function(entry) {
          return new app.Entry(entry);
        });
      }
      this.broadcastChange();
      return this.records;
    };

    EntriesCollection.prototype.save = function() {
      localStorage["dailyq:entries"] = JSON.stringify(this.records);
      this.broadcastChange();
      return this.records;
    };

    EntriesCollection.prototype.add = function(entry) {
      this.records.push(entry);
      return this.save();
    };

    EntriesCollection.prototype.getRecords = function() {
      return this.records;
    };

    EntriesCollection.prototype.reset = function() {
      if (confirm('Are you sure you want to permanently delete all entries?')) {
        this.records = [];
        return this.save();
      } else {

      }
    };

    EntriesCollection.prototype.broadcastChange = function() {
      return document.dispatchEvent(new CustomEvent('entries:changed', {
        detail: {
          entries: this.getRecords()
        }
      }));
    };

    return EntriesCollection;

  })();

  app.Entry = (function() {
    function Entry(args) {
      args || (args = {});
      args.date || (args.date = Date.now());
      if (!(args.answer === 1 || args.answer === 0)) {
        throw "Can't create entry without answer";
      }
      this.setDate(args.date);
      this.setAnswer(args.answer);
    }

    Entry.prototype.getDate = function() {
      return this.date;
    };

    Entry.prototype.setDate = function(date) {
      return this.date = date;
    };

    Entry.prototype.getAnswer = function() {
      return this.answer;
    };

    Entry.prototype.setAnswer = function(answer) {
      return this.answer = answer;
    };

    Entry.prototype.getAttributes = function() {
      return {
        date: this.getDate(),
        answer: this.getAnswer()
      };
    };

    return Entry;

  })();

  Node.prototype.prependChild = function(el) {
    return this.childNodes[0] && this.insertBefore(el, this.childNodes[0]) || this.appendChild(el);
  };

  app.View = (function() {
    function View(el) {
      if (el == null) {
        throw "Cannot construct view without an HTML element";
      }
      this.el = el;
      this.render();
      this.events();
    }

    View.prototype.render = function() {};

    View.prototype.events = function() {};

    return View;

  })();

  app.PromptView = (function(_super) {
    __extends(PromptView, _super);

    function PromptView() {
      return PromptView.__super__.constructor.apply(this, arguments);
    }

    PromptView.prototype.render = function() {
      return this.el.innerHTML = "<h1>" + app.prompt + "</h1>";
    };

    return PromptView;

  })(app.View);

  app.InputView = (function(_super) {
    __extends(InputView, _super);

    function InputView() {
      return InputView.__super__.constructor.apply(this, arguments);
    }

    InputView.prototype.events = function() {
      return this.el.addEventListener('click', this.newEntry);
    };

    InputView.prototype.newEntry = function(e) {
      var target, val;
      target = e.target;
      val = parseInt(target.getAttribute('data-val'));
      return document.dispatchEvent(new CustomEvent('entry:create', {
        detail: {
          answer: val
        }
      }));
    };

    InputView.prototype.render = function() {
      return this.el.innerHTML = "<div data-val=0 class='button button-no'>No</div> <div data-val=1 class='button button-yes'>Yes</div>";
    };

    return InputView;

  })(app.View);

  app.HistoryView = (function(_super) {
    __extends(HistoryView, _super);

    function HistoryView() {
      return HistoryView.__super__.constructor.apply(this, arguments);
    }

    HistoryView.prototype.events = function() {
      return document.addEventListener('entries:changed', this);
    };

    HistoryView.prototype.handleEvent = function(e) {
      if (e.type === 'entries:changed') {
        return this.onEntryChange(e);
      }
    };

    HistoryView.prototype.onEntryChange = function(event) {
      console.log('changed!');
      this.entries = event.detail.entries;
      return this.render();
    };

    HistoryView.prototype.render = function() {
      var entry, _i, _len, _ref, _results;
      if (this.entries != null) {
        _ref = this.entries;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          entry = _ref[_i];
          _results.push(this.renderEntry(entry));
        }
        return _results;
      }
    };

    HistoryView.prototype.renderEntry = function(entry) {
      var elem;
      elem = document.createElement('div');
      elem.className = "entry entry_" + entry.answer;
      elem.id = "entry_" + entry.date;
      elem.innerHTML = entry.date;
      if (document.getElementById(elem.id) == null) {
        return this.el.prependChild(elem);
      }
    };

    return HistoryView;

  })(app.View);

  app.StatsView = (function() {
    function StatsView() {}

    return StatsView;

  })();

}).call(this);
